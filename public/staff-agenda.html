<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mi Agenda - CardioFit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <link rel="shortcut icon" href="logo.jpg" type="image/x-icon">

</head>
<body class="bg-gray-100 font-sans h-screen flex flex-col">

    <nav class="bg-purple-800 text-white p-4 flex justify-between items-center shadow-lg sticky top-0 z-50">
        <h1 class="text-xl font-bold flex items-center gap-2">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            Agenda Personal
        </h1>
        <div class="flex gap-4 items-center">
            <div class="text-right">
                <span id="staffNameDisplay" class="font-bold block leading-none">Cargando...</span>
                <span class="text-xs text-purple-200 uppercase">Panel Staff</span>
            </div>
            <a href="/logout" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded text-sm font-bold transition">Salir</a>
        </div>
    </nav>

    <div class="flex-1 container mx-auto p-4 md:p-6 max-w-5xl overflow-y-auto">
        
        <div class="bg-white rounded-xl shadow-sm p-4 mb-6">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                
                <div class="flex bg-gray-100 rounded-lg p-1 w-full md:w-auto">
                    <button onclick="changeView('day')" id="btn-day" class="view-btn flex-1 px-4 py-2 rounded-md text-sm font-bold transition bg-white text-purple-700 shadow">D칤a</button>
                    <button onclick="changeView('week')" id="btn-week" class="view-btn flex-1 px-4 py-2 rounded-md text-sm font-bold text-gray-500 hover:text-purple-700 transition">Semana</button>
                    <button onclick="changeView('month')" id="btn-month" class="view-btn flex-1 px-4 py-2 rounded-md text-sm font-bold text-gray-500 hover:text-purple-700 transition">Mes</button>
                    <button onclick="changeView('year')" id="btn-year" class="view-btn flex-1 px-4 py-2 rounded-md text-sm font-bold text-gray-500 hover:text-purple-700 transition">A침o</button>
                </div>

                <div class="flex items-center gap-4 bg-purple-50 px-4 py-2 rounded-lg border border-purple-100">
                    <button onclick="navigate(-1)" class="text-purple-600 hover:bg-purple-200 p-1 rounded-full transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <span id="currentDateLabel" class="font-bold text-gray-800 min-w-[150px] text-center capitalize">Hoy</span>
                    <button onclick="navigate(1)" class="text-purple-600 hover:bg-purple-200 p-1 rounded-full transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                </div>
            </div>
        </div>

        <div id="loader" class="hidden text-center py-10">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-purple-700 mx-auto"></div>
            <p class="text-gray-400 mt-2 text-sm">Buscando citas...</p>
        </div>

        <div id="myAgendaContainer" class="space-y-6 pb-10">
            </div>
    </div>

    <script>
        // VARIABLES GLOBALES
        let myStaffId = null;
        let currentView = 'day'; // day, week, month, year
        let referenceDate = new Date();

        // 1. Verificar Sesi칩n
        fetch('/api/check-session')
            .then(res => res.json())
            .then(data => {
                if (!data.loggedin) {
                    window.location.href = '/login.html';
                } else if (data.role !== 'staff') {
                    window.location.href = '/index.html'; 
                } else {
                    document.getElementById('staffNameDisplay').innerText = data.user;
                    myStaffId = data.id;
                    updateLabelAndFetch(); // Carga inicial (D칤a actual)
                }
            });

        // 2. Control de Vistas
        function changeView(view) {
            currentView = view;
            
            // Actualizar estilos de botones
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'text-purple-700', 'shadow');
                btn.classList.add('text-gray-500');
            });
            document.getElementById(`btn-${view}`).classList.add('bg-white', 'text-purple-700', 'shadow');
            document.getElementById(`btn-${view}`).classList.remove('text-gray-500');

            // Resetear a fecha actual al cambiar vista para no perderse
            referenceDate = new Date(); 
            updateLabelAndFetch();
        }

        // 3. Navegaci칩n (Atr치s / Adelante)
        function navigate(direction) {
            const d = new Date(referenceDate);
            
            if (currentView === 'day') d.setDate(d.getDate() + direction);
            if (currentView === 'week') d.setDate(d.getDate() + (direction * 7));
            if (currentView === 'month') d.setMonth(d.getMonth() + direction);
            if (currentView === 'year') d.setFullYear(d.getFullYear() + direction);

            referenceDate = d;
            updateLabelAndFetch();
        }

        // 4. Calcular Rangos y Actualizar Etiqueta
        function updateLabelAndFetch() {
            const label = document.getElementById('currentDateLabel');
            let startStr, endStr;
            let displayLabel = '';

            const y = referenceDate.getFullYear();
            const m = referenceDate.getMonth();
            const d = referenceDate.getDate();

            if (currentView === 'day') {
                displayLabel = referenceDate.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                startStr = formatDateISO(referenceDate);
                endStr = formatDateISO(referenceDate);
            } 
            else if (currentView === 'week') {
                // Calcular inicio (Lunes) y fin (Domingo) de la semana
                const dayOfWeek = referenceDate.getDay(); // 0 (Domingo) - 6 (S치bado)
                const diffToMonday = (dayOfWeek + 6) % 7; 
                
                const start = new Date(referenceDate);
                start.setDate(d - diffToMonday);
                
                const end = new Date(start);
                end.setDate(start.getDate() + 6);

                displayLabel = `${start.getDate()} - ${end.getDate()} ${end.toLocaleDateString('es-ES', { month: 'short' })}`;
                startStr = formatDateISO(start);
                endStr = formatDateISO(end);
            } 
            else if (currentView === 'month') {
                displayLabel = referenceDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                const start = new Date(y, m, 1);
                const end = new Date(y, m + 1, 0); // 칔ltimo d칤a del mes
                startStr = formatDateISO(start);
                endStr = formatDateISO(end);
            } 
            else if (currentView === 'year') {
                displayLabel = y.toString();
                startStr = `${y}-01-01`;
                endStr = `${y}-12-31`;
            }

            label.innerText = displayLabel;
            fetchAppointments(startStr, endStr);
        }

        // 5. Consumir API
        function fetchAppointments(start, end) {
            const container = document.getElementById('myAgendaContainer');
            const loader = document.getElementById('loader');
            
            container.innerHTML = '';
            loader.classList.remove('hidden');

            fetch(`/api/appointments/staff-range?staffId=${myStaffId}&start=${start}&end=${end}`)
                .then(res => res.json())
                .then(citas => {
                    loader.classList.add('hidden');
                    renderAppointments(citas);
                })
                .catch(err => {
                    loader.classList.add('hidden');
                    container.innerHTML = `<div class="text-center text-red-500">Error cargando agenda.</div>`;
                });
        }

        // 6. Renderizar Resultados
        function renderAppointments(citas) {
            const container = document.getElementById('myAgendaContainer');

            if (citas.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12 text-gray-400 bg-white rounded-xl shadow border border-gray-100">
                        <svg class="w-12 h-12 mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        <p class="font-medium">No hay citas programadas para este periodo.</p>
                    </div>`;
                return;
            }

            // Agrupar citas por d칤a para vistas que no sean 'day'
            const grouped = {};
            citas.forEach(cita => {
                const dateKey = cita.appointment_date.split('T')[0];
                if (!grouped[dateKey]) grouped[dateKey] = [];
                grouped[dateKey].push(cita);
            });

            // Ordenar claves de fecha
            Object.keys(grouped).sort().forEach(dateKey => {
                // Solo mostrar cabecera de fecha si NO estamos en vista diaria
                if (currentView !== 'day') {
                    const dateObj = new Date(dateKey);
                    // Ajuste zona horaria manual simple para visualizaci칩n correcta del d칤a
                    const userTimezoneOffset = dateObj.getTimezoneOffset() * 60000;
                    const adjustedDate = new Date(dateObj.getTime() + userTimezoneOffset);
                    
                    const dateStr = adjustedDate.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                    
                    container.innerHTML += `
                        <div class="sticky top-20 bg-gray-100/95 backdrop-blur py-2 z-10 border-b border-gray-200 mb-2">
                            <h3 class="text-gray-600 font-bold uppercase text-sm tracking-wide">游늰 ${dateStr}</h3>
                        </div>
                    `;
                }

                // Renderizar GRID de citas para ese d칤a
                const gridDiv = document.createElement('div');
                gridDiv.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6';

                grouped[dateKey].forEach(cita => {
                    const hora = cita.start_time.substring(0, 5);
                    const whatsappBtn = generateWhatsappLink(cita.cliente, cita.TELEFONO, cita.appointment_date, hora);
                    
                    gridDiv.innerHTML += `
                        <div class="bg-white border-l-4 border-purple-500 p-5 rounded-lg shadow-sm hover:shadow-md transition flex flex-col justify-between">
                            <div class="mb-3">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-2xl font-bold text-purple-700 font-mono">${hora}</span>
                                    <span class="bg-green-100 text-green-700 text-xs px-2 py-0.5 rounded-full font-bold">Confirmada</span>
                                </div>
                                <h3 class="font-bold text-gray-800 text-lg leading-tight">${cita.cliente}</h3>
                                <p class="text-xs text-gray-400 mt-1 uppercase tracking-wide">${cita.PLAN || 'Plan no especificado'}</p>
                            </div>
                            ${whatsappBtn}
                        </div>
                    `;
                });
                container.appendChild(gridDiv);
            });
        }

        // Utilitario: Formato ISO YYYY-MM-DD
        function formatDateISO(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Utilitario: Bot칩n WhatsApp
        function generateWhatsappLink(nombre, telefono, fecha, hora) {
            if (!telefono) return '';
            
            let tel = telefono.replace(/\D/g, '');
            if (!tel.startsWith('57') && tel.length === 10) tel = '57' + tel;

            // Formatear fecha para el mensaje
            const fechaObj = new Date(fecha);
            const fechaMsg = fechaObj.toLocaleDateString('es-ES', { day: 'numeric', month: 'long' });

            const mensaje = `Hola ${nombre}, te escribe tu entrenador de CardioFit. Confirmando nuestra sesi칩n programada para el ${fechaMsg} a las ${hora}.`;
            const url = `https://wa.me/${tel}?text=${encodeURIComponent(mensaje)}`;

            return `
                <a href="${url}" target="_blank" class="text-center text-sm font-bold text-green-600 bg-green-50 hover:bg-green-100 py-2 rounded transition flex items-center justify-center gap-2 mt-auto">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372s-1.04 1.016-1.04 2.479 1.065 2.876 1.213 3.074c.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
                    Confirmar
                </a>`;
        }
    </script>
</body>
</html>