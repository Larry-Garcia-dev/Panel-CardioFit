<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mi Agenda - CardioFit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="shortcut icon" href="logo.jpg" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Ocultar scrollbar pero permitir scroll */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col">

    <nav class="bg-purple-900 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex flex-wrap justify-between items-center gap-3">
            <h1 class="text-lg md:text-xl font-extrabold tracking-tight flex items-center gap-2">
                <svg class="w-6 h-6 text-purple-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                MI AGENDA
            </h1>
            
            <div class="flex items-center gap-3 md:gap-6 ml-auto">
                <div class="text-right leading-tight">
                    <span id="staffNameDisplay" class="font-bold text-sm md:text-base block">Cargando...</span>
                    <span class="text-[10px] md:text-xs text-purple-300 uppercase tracking-wider">Staff CardioFit</span>
                </div>
                <a href="/logout" class="bg-purple-700 hover:bg-red-600 text-white p-2 md:px-4 md:py-2 rounded-lg text-xs md:text-sm font-bold transition flex items-center gap-1 shadow-md">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    <span class="hidden md:inline">Salir</span>
                </a>
            </div>
        </div>
    </nav>

    <div class="flex-1 container mx-auto p-3 md:p-6 max-w-6xl overflow-y-auto no-scrollbar">
        
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-3 md:p-4 mb-6 sticky top-0 md:static z-40">
            <div class="flex flex-col lg:flex-row justify-between items-center gap-4">
                
                <div class="flex bg-gray-100 rounded-xl p-1 w-full lg:w-auto overflow-x-auto no-scrollbar">
                    <button onclick="changeView('day')" id="btn-day" class="view-btn flex-1 min-w-[70px] px-3 py-2 rounded-lg text-xs md:text-sm font-bold transition bg-white text-purple-700 shadow-sm border border-gray-200">Día</button>
                    <button onclick="changeView('week')" id="btn-week" class="view-btn flex-1 min-w-[70px] px-3 py-2 rounded-lg text-xs md:text-sm font-bold text-gray-500 hover:text-purple-700 transition">Semana</button>
                    <button onclick="changeView('month')" id="btn-month" class="view-btn flex-1 min-w-[70px] px-3 py-2 rounded-lg text-xs md:text-sm font-bold text-gray-500 hover:text-purple-700 transition">Mes</button>
                </div>

                <div class="flex items-center justify-between w-full lg:w-auto gap-4 bg-purple-50 px-2 py-1.5 md:px-4 md:py-2 rounded-xl border border-purple-100">
                    <button onclick="navigate(-1)" class="text-purple-700 hover:bg-white hover:shadow p-2 rounded-full transition active:scale-95">
                        <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <span id="currentDateLabel" class="font-extrabold text-gray-800 text-sm md:text-lg text-center capitalize min-w-[120px]">Hoy</span>
                    <button onclick="navigate(1)" class="text-purple-700 hover:bg-white hover:shadow p-2 rounded-full transition active:scale-95">
                        <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                </div>
            </div>
        </div>

        <div id="loader" class="hidden text-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-purple-700 mx-auto"></div>
            <p class="text-gray-400 mt-4 text-sm font-medium animate-pulse">Sincronizando agenda...</p>
        </div>

        <div id="myAgendaContainer" class="space-y-8 pb-20"></div>
    </div>

    <script>
        // VARIABLES GLOBALES
        let myStaffId = null;
        let currentView = 'day'; // day, week, month, year
        let referenceDate = new Date();

        // 1. Verificar Sesión
        fetch('/api/check-session')
            .then(res => res.json())
            .then(data => {
                if (!data.loggedin) {
                    window.location.href = '/login.html';
                } else if (data.role !== 'staff') {
                    window.location.href = '/index.html'; 
                } else {
                    document.getElementById('staffNameDisplay').innerText = data.user.split(' ')[0]; // Solo primer nombre
                    myStaffId = data.id;
                    updateLabelAndFetch(); // Carga inicial
                }
            });

        // 2. Control de Vistas
        function changeView(view) {
            currentView = view;
            
            // Actualizar estilos de botones
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.className = "view-btn flex-1 min-w-[70px] px-3 py-2 rounded-lg text-xs md:text-sm font-bold text-gray-500 hover:text-purple-700 transition";
            });
            const activeBtn = document.getElementById(`btn-${view}`);
            activeBtn.className = "view-btn flex-1 min-w-[70px] px-3 py-2 rounded-lg text-xs md:text-sm font-bold transition bg-white text-purple-700 shadow-sm border border-gray-200";

            referenceDate = new Date(); 
            updateLabelAndFetch();
        }

        // 3. Navegación
        function navigate(direction) {
            const d = new Date(referenceDate);
            if (currentView === 'day') d.setDate(d.getDate() + direction);
            if (currentView === 'week') d.setDate(d.getDate() + (direction * 7));
            if (currentView === 'month') d.setMonth(d.getMonth() + direction);
            
            referenceDate = d;
            updateLabelAndFetch();
        }

        // 4. Calcular Rangos y Etiquetas
        function updateLabelAndFetch() {
            const label = document.getElementById('currentDateLabel');
            let startStr, endStr;
            let displayLabel = '';

            const y = referenceDate.getFullYear();
            const m = referenceDate.getMonth();
            const d = referenceDate.getDate();

            if (currentView === 'day') {
                displayLabel = referenceDate.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                startStr = formatDateISO(referenceDate);
                endStr = formatDateISO(referenceDate);
            } 
            else if (currentView === 'week') {
                const dayOfWeek = referenceDate.getDay(); 
                const diffToMonday = (dayOfWeek + 6) % 7; 
                const start = new Date(referenceDate);
                start.setDate(d - diffToMonday);
                const end = new Date(start);
                end.setDate(start.getDate() + 6);

                displayLabel = `${start.getDate()} - ${end.getDate()} ${end.toLocaleDateString('es-ES', { month: 'short' })}`;
                startStr = formatDateISO(start);
                endStr = formatDateISO(end);
            } 
            else if (currentView === 'month') {
                displayLabel = referenceDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                const start = new Date(y, m, 1);
                const end = new Date(y, m + 1, 0);
                startStr = formatDateISO(start);
                endStr = formatDateISO(end);
            }

            label.innerText = displayLabel;
            fetchAppointments(startStr, endStr);
        }

        // 5. Fetch API
        function fetchAppointments(start, end) {
            const container = document.getElementById('myAgendaContainer');
            const loader = document.getElementById('loader');
            
            container.innerHTML = '';
            loader.classList.remove('hidden');

            fetch(`/api/appointments/staff-range?staffId=${myStaffId}&start=${start}&end=${end}`)
                .then(res => res.json())
                .then(citas => {
                    loader.classList.add('hidden');
                    renderAppointments(citas);
                })
                .catch(err => {
                    loader.classList.add('hidden');
                    container.innerHTML = `<div class="bg-red-50 p-4 rounded-xl text-center text-red-600 font-bold border border-red-100">⚠️ Error cargando la agenda.</div>`;
                });
        }

        // 6. Renderizar Tarjetas
        function renderAppointments(citas) {
            const container = document.getElementById('myAgendaContainer');

            if (citas.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-16 text-gray-400 bg-white rounded-3xl border border-gray-100 shadow-sm mx-4">
                        <div class="bg-gray-50 p-4 rounded-full mb-3">
                            <svg class="w-10 h-10 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                        <p class="font-bold text-lg">Todo libre por aquí</p>
                        <p class="text-xs">No hay citas programadas para este periodo.</p>
                    </div>`;
                return;
            }

            // Agrupar por fecha
            const grouped = {};
            citas.forEach(cita => {
                const dateKey = cita.appointment_date.split('T')[0];
                if (!grouped[dateKey]) grouped[dateKey] = [];
                grouped[dateKey].push(cita);
            });

            // Ordenar y mostrar
            Object.keys(grouped).sort().forEach(dateKey => {
                // Cabecera de fecha (solo si no es vista de día único)
                if (currentView !== 'day') {
                    const dateObj = new Date(`${dateKey}T12:00:00`); // Fix timezone simple
                    const dateStr = dateObj.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                    
                    container.innerHTML += `
                        <div class="sticky top-0 bg-gray-50/95 backdrop-blur py-3 z-10 border-b border-gray-200 mb-2 mt-4 px-2">
                            <h3 class="text-purple-800 font-black uppercase text-sm tracking-widest flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-purple-500"></span> ${dateStr}
                            </h3>
                        </div>
                    `;
                }

                const gridDiv = document.createElement('div');
                gridDiv.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-2';

                grouped[dateKey].forEach(cita => {
                    const hora = cita.start_time.substring(0, 5);
                    const whatsappBtn = generateWhatsappLink(cita.cliente, cita.TELEFONO, cita.appointment_date, hora);
                    
                    // --- AQUÍ ESTÁ EL CAMBIO PRINCIPAL: MOSTRAR SERVICIO ---
                    const servicio = cita.service_name ? cita.service_name : 'Cita General';
                    const planUsuario = cita.PLAN || 'Sin plan';

                    gridDiv.innerHTML += `
                        <div class="bg-white border border-gray-100 rounded-2xl p-5 shadow-sm hover:shadow-lg transition-all duration-300 relative overflow-hidden group">
                            <div class="absolute top-0 left-0 w-1.5 h-full bg-gradient-to-b from-purple-500 to-blue-500"></div>
                            
                            <div class="flex flex-col h-full justify-between gap-3 pl-2">
                                <div>
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="text-3xl font-black text-gray-800 tracking-tighter">${hora}</span>
                                        <div class="text-right">
                                            <span class="bg-green-100 text-green-700 text-[10px] px-2 py-1 rounded-full font-bold uppercase tracking-wide border border-green-200">Confirmada</span>
                                        </div>
                                    </div>
                                    
                                    <h3 class="font-bold text-gray-900 text-lg leading-snug mb-1 group-hover:text-purple-700 transition line-clamp-1" title="${cita.cliente}">
                                        ${cita.cliente.toLowerCase().replace(/\b\w/g, l => l.toUpperCase())}
                                    </h3>

                                    <div class="mb-2">
                                        <span class="block text-[10px] text-gray-400 font-bold uppercase tracking-wider">Servicio:</span>
                                        <p class="text-sm font-bold text-blue-600 leading-tight">${servicio}</p>
                                    </div>

                                    <div>
                                        <span class="block text-[10px] text-gray-400 font-bold uppercase tracking-wider">Plan:</span>
                                        <p class="text-xs text-gray-500 truncate" title="${planUsuario}">${planUsuario}</p>
                                    </div>
                                </div>
                                
                                ${whatsappBtn}
                            </div>
                        </div>
                    `;
                });
                container.appendChild(gridDiv);
            });
        }

        function formatDateISO(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function generateWhatsappLink(nombre, telefono, fecha, hora) {
            if (!telefono) return '';
            
            let tel = telefono.replace(/\D/g, '');
            if (!tel.startsWith('57') && tel.length === 10) tel = '57' + tel;

            // Fecha bonita
            const fechaObj = new Date(fecha);
            // Ajuste zona horaria manual para visualización en mensaje
            const userTimezoneOffset = fechaObj.getTimezoneOffset() * 60000;
            const adjustedDate = new Date(fechaObj.getTime() + userTimezoneOffset);
            const fechaMsg = adjustedDate.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });

            const mensaje = `Hola ${nombre}, te escribe tu especialista de CardioFit. Confirmando nuestra sesión de *${fechaMsg} a las ${hora}*.`;
            const url = `https://wa.me/${tel}?text=${encodeURIComponent(mensaje)}`;

            return `
                `;
        }
    </script>
</body>
</html>